with competitors as (
    select 
        competitor_id,
        event_id,
        competitor_name,
        country,
        country_code,
        abbreviation,
        qualifier,
        gender
    from {{ ref('stg__competitor') }}
),

venue as (
    select 
        venue_id,
        event_id,
        venue_name,
        capacity,
        city_name,
        country_name,
        map_coordinates,
        country_code,
        timezone
    from {{ ref('stg__venue') }}
),

sport_event_conditions as (
    select 
        event_id,
        referee_id,
        referee_name,
        nationality,
        country_code,
        type,
        attendance,
        pitch_weather_conditions,
        overall_weather_conditions,
        neutral_ground,
        lineups_confirmed
    from {{ ref('stg__sport_event_conditions') }}
),

sport_event_status as(
    select 
        event_id,
        status,
        match_status,
        home_score,
        away_score,
        home_normaltime_score,
        away_normaltime_score,
        home_overtime_score,
        away_overtime_score,
        winner_id,
        aggregate_home_score,
        aggregate_away_score,
        aggregate_winner_id,
        match_tie
    from {{ ref('stg__sport_event_status') }}
),

team_stats as (
    select 
        event_id,
        competitor_id,
        ball_possession as competitor_ball_possession,
        cards_given as competitor_cards_given,
        chances_created as competitor_chances_created,
        clearances as competitor_clearances,
        corner_kicks as competitor_corner_kicks,
        crosses_successful as competitor_crosses_successful,
        crosses_total as competitor_crosses_total,
        crosses_unsuccessful as competitor_crosses_unsuccessful,
        defensive_blocks as competitor_defensive_blocks,
        diving_saves as competitor_diving_saves,
        dribbles_completed as competitor_dribbles_completed,
        fouls as competitor_fouls,
        free_kicks as competitor_free_kicks,
        goal_kicks as competitor_goal_kicks,
        interceptions as competitor_interceptions,
        long_passes_successful as competitor_long_passes_successful,
        long_passes_total as competitor_long_passes_total,
        long_passes_unsuccessful as competitor_long_passes_unsuccessful,
        loss_of_possession as competitor_loss_of_possession,
        offsides as competitor_offsides,
        passes_successful as competitor_passes_successful,
        passes_total as competitor_passes_total,
        passes_unsuccessful as competitor_passes_unsuccessful,
        red_cards as competitor_red_cards,
        shots_blocked as competitor_shots_blocked,
        shots_off_target as competitor_shots_off_target,
        shots_on_target as competitor_shots_on_target,
        shots_saved as competitor_shots_saved,
        shots_total as competitor_shots_total,
        substitutions as competitor_substitutions,
        tackles_successful as competitor_tackles_successful,
        tackles_total as competitor_tackles_total,
        tackles_unsuccessful as competitor_tackles_unsuccessful,
        throw_ins as competitor_throw_ins,
        was_fouled as competitor_was_fouled,
        yellow_cards as competitor_yellow_cards,
        yellow_red_cards as competitor_yellow_red_cards
    from {{ ref('stg__match_stats') }}
),

player_stats as (
    select 
        event_id,
        competitor_id,
        player_id,
        player_name,
        starter,
        assists,
        chances_created,
        clearances,
        corner_kicks,
        crosses_successful,
        crosses_total,
        defensive_blocks,
        diving_saves,
        dribbles_completed,
        fouls_committed,
        goals_by_head,
        goals_by_penalty,
        goals_conceded,
        goals_scored,
        interceptions,
        long_passes_successful,
        long_passes_total,
        long_passes_unsuccessful,
        loss_of_possession,
        minutes_played,
        offsides,
        own_goals,
        passes_successful,
        passes_total,
        passes_unsuccessful,
        penalties_faced,
        penalties_missed,
        penalties_saved,
        red_cards,
        shots_blocked,
        shots_faced_saved,
        shots_faced_total,
        shots_off_target,
        shots_on_target,
        substituted_in,
        substituted_out,
        tackles_successful,
        tackles_total,
        was_fouled,
        yellow_cards,
        yellow_red_cards
    from {{ ref('stg__player_stats') }}
)

select
    event_id,
    start_time, 
    start_time_confirmed,
    sport_id,
    sport_name,
    category_id,
    category_name,
    competition_id,
    competition_name,
    gender,
    venue_id,
    venue_name,
    capacity,
    city_name,
    country_name,
    map_coordinates,
    timezone,
    season_id,
    season_name,
    season_start_date,
    season_end_date,
    year,
    stage_order,
    stage_type,
    phase,
    stage_start_date,
    stage_end_date,
    stage_year,
    round_name,
    cup_round_sport_event_number,
    cup_round_number_of_sport_events,
    cup_round_id,
    group_id,
    group_name,
    competitor_id,
    competitor_name,
    country,
    country_code,
    abbreviation,
    qualifier,
    referee_id,
    referee_name,
    nationality,
    type,
    attendance,
    pitch_weather_conditions,
    overall_weather_conditions,
    neutral_ground,
    lineups_confirmed,
    status,
    match_status,
    case
        when qualifier = 'home' then home_score
        else away_score
    end as goals,
    winner_id,
    match_tie,
    competitor_ball_possession,
    competitor_cards_given,
    competitor_chances_created,
    competitor_clearances,
    competitor_corner_kicks,
    competitor_crosses_successful,
    competitor_crosses_total,
    competitor_crosses_unsuccessful,
    competitor_defensive_blocks,
    competitor_diving_saves,
    competitor_dribbles_completed,
    competitor_fouls,
    competitor_free_kicks,
    competitor_goal_kicks,
    competitor_interceptions,
    competitor_long_passes_successful,
    competitor_long_passes_total,
    competitor_long_passes_unsuccessful,
    competitor_loss_of_possession,
    competitor_offsides,
    competitor_passes_successful,
    competitor_passes_total,
    competitor_passes_unsuccessful,
    competitor_red_cards,
    competitor_shots_blocked,
    competitor_shots_off_target,
    competitor_shots_on_target,
    competitor_shots_saved,
    competitor_shots_total,
    competitor_substitutions,
    competitor_tackles_successful,
    competitor_tackles_total,
    competitor_tackles_unsuccessful,
    competitor_throw_ins,
    competitor_was_fouled,
    competitor_yellow_cards,
    competitor_yellow_red_cards,
    player_id,
    player_name,
    starter,
    assists,
    chances_created,
    clearances,
    corner_kicks,
    crosses_successful,
    crosses_total,
    defensive_blocks,
    diving_saves,
    dribbles_completed,
    fouls_committed,
    goals_by_head,
    goals_by_penalty,
    goals_conceded,
    goals_scored,
    interceptions,
    long_passes_successful,
    long_passes_total,
    long_passes_unsuccessful,
    loss_of_possession,
    minutes_played,
    offsides,
    own_goals,
    passes_successful,
    passes_total,
    passes_unsuccessful,
    penalties_faced,
    penalties_missed,
    penalties_saved,
    red_cards,
    shots_blocked,
    shots_faced_saved,
    shots_faced_total,
    shots_off_target,
    shots_on_target,
    substituted_in,
    substituted_out,
    tackles_successful,
    tackles_total,
    was_fouled,
    yellow_cards,
    yellow_red_cards

from {{ ref('stg__sports_event') }}
left join competitors using (event_id)
left join venue using (event_id)
left join sport_event_conditions using (event_id)
left join sport_event_status using (event_id)
left join team_stats using (event_id, competitor_id)
left join player_stats using (event_id, competitor_id)